<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∑t h√†ng</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #f5f5f5; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #eee; }
        input[type="number"] { width: 60px; }
        .btn {
            padding: 6px 12px; background-color: #3498db; color: white;
            border: none; border-radius: 6px; cursor: pointer; margin-right: 5px;
        }
        .btn:hover { background-color: #2980b9; }
        .btn-danger { background-color: #e74c3c; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-save { background-color: #2ecc71; }
        .btn-save:hover { background-color: #27ae60; }
        .cart { margin-bottom: 30px; padding: 20px; background: #fff; border: 1px solid #ccc; border-radius: 10px; }
        .total { text-align: right; margin-top: 10px; font-weight: bold; }
        .method { margin-top: 20px; }
        #qrModal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center;
        }
        #qrModal .content {
            background: #fff; padding: 20px; border-radius: 12px; text-align: center;
        }
    </style>
</head>
<body>

<h2>üõí Gi·ªè h√†ng</h2>
<div class="cart">
    <table id="cartTable">
        <thead>
        <tr><th>T√™n SP</th><th>Gi√°</th><th>S·ªë l∆∞·ª£ng</th><th>Th√†nh ti·ªÅn</th><th>H√†nh ƒë·ªông</th></tr>
        </thead>
        <tbody id="cartBody"></tbody>
    </table>
    <div class="total">T·ªïng ti·ªÅn: <span id="total">0</span> ƒë</div>

    <div class="method">
        <label><input type="radio" name="method" value="cash" checked> üíµ Ti·ªÅn m·∫∑t</label>
        <label><input type="radio" name="method" value="bank"> üè¶ Chuy·ªÉn kho·∫£n</label>
    </div>

    <button class="btn btn-save" onclick="thanhToan()">üí≥ Thanh to√°n</button>
</div>
<footer style="text-align:center; font-size:13px; color:#888; margin-top:40px;">
    Ngu·ªìn tr√™n thu·ªôc quy·ªÅn s·ªü h·ªØu c·ªßa <strong>B√¨nh Chu</strong>. Vui l√≤ng kh√¥ng reup d∆∞·ªõi b·∫•t k·ª≥ h√¨nh th·ª©c n√†o.
    <br> Li√™n h·ªá h·ªó tr·ª£, c√¥ng vi·ªác Zalo: 0389415404 ‚Äì
    Fb: <a href="https://www.facebook.com/binh.chu.434869" target="_blank" style="color:#3b5998; text-decoration:none;"><strong>B√¨nh Chu</strong></a>
</footer>
<h2>üì¶ Danh s√°ch s·∫£n ph·∫©m</h2>
<table>
    <thead>
    <tr><th>T√™n</th><th>Gi√°</th><th>S·ªë l∆∞·ª£ng</th><th></th></tr>
    </thead>
    <tbody>
    <tr th:each="sp, iStat : ${dsSanPham}">
        <td th:text="${sp.tenSanPham}">T√™n SP</td>
        <td th:text="${#numbers.formatDecimal(sp.donGia, 0, 'POINT', 0, 'COMMA')} + ' ƒë'">0</td>

        <td><input type="number" min="1" value="1" th:id="'qty-' + ${iStat.index}"></td>
        <td>
            <button class="btn"
                    th:attr="onclick=|addToCart('${sp.tenSanPham}', ${sp.donGia}, 'qty-${iStat.index}')|">
                Th√™m
            </button>
        </td>
    </tr>
    </tbody>
</table>

<!-- Modal QR chuy·ªÉn kho·∫£n -->
<div id="qrModal">
    <div class="content">
        <h3>üîÅ Chuy·ªÉn kho·∫£n</h3>
        <p><strong>Ng√¢n h√†ng:</strong> <span id="bankName">MB</span></p>
        <p><strong>S·ªë t√†i kho·∫£n:</strong> <span id="accountNumber">0389415404</span></p>
        <p><strong>Ch·ªß t√†i kho·∫£n:</strong> <span id="accountName">CHU DINH BINH</span></p>
        <p><strong>S·ªë ti·ªÅn:</strong> <span id="qrAmount">0</span> ƒë</p>
        <p><strong>N·ªôi dung:</strong> <span id="qrNote">Thanh toan don hang</span></p>
        <img id="qrImage" src="" alt="QR chuy·ªÉn kho·∫£n" style="max-width: 300px; margin: 20px auto;">
        <br>
        <button class="btn btn-danger" onclick="document.getElementById('qrModal').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<script>
    const cart = [];

    function addToCart(name, price, qtyId) {
        const qty = parseInt(document.getElementById(qtyId).value);
        if (qty <= 0) return alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá");

        const existing = cart.find(item => item.name === name);
        if (existing) {
            existing.qty += qty;
        } else {
            cart.push({name, price, qty, editing: false});
        }
        renderCart();
    }

    function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function editItem(index) {
        cart[index].editing = true;
        renderCart();
    }

    function saveItem(index) {
        const newQty = parseInt(document.getElementById("editQty-" + index).value);
        if (newQty <= 0) return alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá");
        cart[index].qty = newQty;
        cart[index].editing = false;
        renderCart();
    }

    function renderCart() {
        const tbody = document.getElementById("cartBody");
        const totalSpan = document.getElementById("total");
        tbody.innerHTML = "";
        let total = 0;

        cart.forEach((item, i) => {
            const thanhTien = item.price * item.qty;
            total += thanhTien;
            const row = document.createElement("tr");
            row.innerHTML = item.editing
                ? `<td>${item.name}</td><td>${item.price} ƒë</td>
                   <td><input type="number" id="editQty-${i}" value="${item.qty}" min="1"></td>
                   <td>${thanhTien} ƒë</td>
                   <td><button class="btn btn-save" onclick="saveItem(${i})">üíæ L∆∞u</button></td>`
                : `<td>${item.name}</td><td>${item.price} ƒë</td>
                   <td>${item.qty}</td><td>${thanhTien} ƒë</td>
                   <td>
                       <button class="btn" onclick="editItem(${i})">üìù S·ª≠a</button>
                       <button class="btn btn-danger" onclick="removeItem(${i})">Xo√°</button>
                   </td>`;
            tbody.appendChild(row);
        });

        totalSpan.textContent = total.toLocaleString();
    }

    function thanhToan() {
        const method = document.querySelector('input[name="method"]:checked').value;
        if (cart.length === 0) return alert("üõí Gi·ªè h√†ng tr·ªëng");

        const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

        // T·∫°o d·ªØ li·ªáu ƒë√∫ng v·ªõi DonHangDTO trong Java
        const gioHangDTO = cart.map(item => ({
            ten: item.name,         // ph·∫£i tr√πng v·ªõi t√™n bi·∫øn trong DonHangDTO.java
            soLuong: item.qty,
            donGia: item.price
        }));

        if (method === "cash") {
            // G·ª≠i d·ªØ li·ªáu l√™n server ƒë·ªÉ tr·ª´ h√†ng + t√≠nh t·ªïng ti·ªÅn
            fetch("/don-hang/thanh-toan", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(gioHangDTO)
            })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    cart.length = 0;   // X√≥a gi·ªè h√†ng sau khi thanh to√°n
                    renderCart();
                })
                .catch(err => {
                    console.error("L·ªói:", err);
                    alert("‚ùå L·ªói khi g·ª≠i ƒë∆°n h√†ng");
                });
        } else if (method === "bank") {
            const stk = "0389415404";
            const ten = "CHU DINH BINH";
            const bank = "MB";
            const note = "Thanh toan don hang";

            // D√πng d·ªãch v·ª• vietqr ƒë·ªÉ t·∫°o m√£ QR thanh to√°n
            const qrUrl = `https://img.vietqr.io/image/${bank}-${stk}-compact.png?amount=${total}&addInfo=${encodeURIComponent(note)}&accountName=${encodeURIComponent(ten)}`;

            // G√°n c√°c th√¥ng tin v√†o modal QR
            document.getElementById("qrImage").src = qrUrl;
            document.getElementById("accountNumber").innerText = stk;
            document.getElementById("accountName").innerText = ten;
            document.getElementById("qrAmount").innerText = total.toLocaleString();
            document.getElementById("qrNote").innerText = note;
            document.getElementById("qrModal").style.display = "flex";
        }
    }


</script>


</body>
</html>
